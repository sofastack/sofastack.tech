---
title: "Go å†…å­˜æ³„æ¼ï¼Œpprof å¤Ÿç”¨äº†å—ï¼Ÿ"
authorlink: "https://github.com/sofastack"
description: "Go å†…å­˜æ³„æ¼ï¼Œpprof å¤Ÿç”¨äº†å—ï¼Ÿ"
categories: "SOFAStack"
tags: ["SOFAStack"]
date: 2022-09-13T15:00:00+08:00
cover: "https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*EvZlQbIx3cEAAAAAAAAAAAAAARQnAQ"
---

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f9763d214ac4a2bb684e5ea9f4713fd~tplv-k3u1fbpfcp-zoom-1.image)

æ–‡ï½œæœ±å¾·æ±Ÿï¼ˆGitHub IDï¼šdoujiang24)

MOSN é¡¹ç›®æ ¸å¿ƒå¼€å‘è€…ã€èš‚èšé›†å›¢æŠ€æœ¯ä¸“å®¶

*ä¸“æ³¨äºäº‘åŸç”Ÿç½‘å…³ç ”å‘çš„ç›¸å…³å·¥ä½œ*

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87dcc4b074a44dfdb7e393faa5abacc7~tplv-k3u1fbpfcp-zoom-1.image)

***æœ¬æ–‡ 2651 å­— é˜…è¯»Â 8 åˆ†é’Ÿ***

*MOSN æ˜¯ä¸»è¦ä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„äº‘åŸç”Ÿç½‘ç»œä»£ç†å¹³å°ï¼Œåœ¨èš‚èšé›†å›¢æœ‰ç€å‡ åä¸‡å®¹å™¨çš„å¤§è§„æ¨¡ç”Ÿäº§åº”ç”¨ã€‚åœ¨è¿™ç§å¤§è§„æ¨¡çš„åº”ç”¨ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°å„ç§å†…å­˜é—®é¢˜ï¼Œé€šå¸¸æƒ…å†µä¸‹ pprof heap profile å¯ä»¥å¾ˆå¥½å¸®åŠ©åˆ†æé—®é¢˜ã€‚ä¸è¿‡ï¼Œæœ‰æ—¶å€™ pprof ä¹Ÿä¸å¤Ÿç”¨ï¼Œä¹Ÿå°±éœ€è¦æˆ‘ä»¬æœ‰æ›´åˆé€‚çš„å·¥å…·äº†ã€‚*

## Part.1--å‡ºç”Ÿè¯ vs æš‚ä½è¯

é¦–å…ˆ pprof ç¡®å®å¾ˆå¥½ç”¨ï¼Œè®¾è®¡å®ç°ä¹Ÿéƒ½å¾ˆç²¾å·§ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æŸ¥çœ‹è¿™ç¯‡ã€ŠGo è¯­è¨€ pprof heap profile å®ç°æœºåˆ¶ã€‹[1]ã€‚

ç”¨ pprof æ¥åˆ†æå†…å­˜æ³„æ¼ï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯å¤Ÿç”¨äº†ï¼Œä¸è¿‡æœ‰æ—¶å€™ï¼Œä¹Ÿä¼šä¸å¤Ÿç”¨ã€‚

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º **pprof åªæ˜¯è®°å½•äº†å†…å­˜å¯¹è±¡è¢«åˆ›å»ºæ—¶çš„è°ƒç”¨æ ˆï¼Œå¹¶æ²¡æœ‰å¼•ç”¨å…³ç³»**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰åŠæ³•çŸ¥é“ï¼Œå†…å­˜å¯¹è±¡æ˜¯å› ä¸ºè¢«è°å¼•ç”¨äº†è€Œå¯¼è‡´æ²¡æœ‰è¢«é‡Šæ”¾ã€‚å¯¹æ­¤ï¼Œæˆ‘çš„åŒäº‹--çƒˆå…ƒåŒå­¦æœ‰ä¸€ä¸ªå¾ˆå½¢è±¡çš„æ¯”å–»ï¼Œpprof åªèƒ½çœ‹åˆ°å‡ºç”Ÿè¯ï¼Œå´æŸ¥ä¸äº†æš‚ä½è¯ã€‚

## Part.2--éœ€è¦å¼•ç”¨å…³ç³»

æœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ³„æ¼çš„å†…å­˜æ˜¯ä»å“ªé‡Œç”³è¯·çš„ï¼Œä½†æ˜¯ç¿»äº†åŠå¤©ä»£ç ï¼Œä¹Ÿæä¸æ¸…æ¥šå†…å­˜ä¸ºä»€ä¹ˆæ²¡æœ‰é‡Šæ”¾ã€‚æ¯”å¦‚ï¼Œå†…å­˜å¯¹è±¡ç»è¿‡å¤æ‚çš„è°ƒç”¨ä¼ é€’ï¼Œæˆ–è€…å¤æ‚çš„å†…å­˜æ± å¤ç”¨æœºåˆ¶ï¼Œåˆæˆ–è€…ä¼ ç»™äº†æŸä¸ªä¸ç†Ÿæ‚‰çš„ç¬¬ä¸‰æ–¹åº“ï¼Œåœ¨ç¬¬ä¸‰æ–¹åº“ä¸­æœ‰éé¢„æœŸçš„ä½¿ç”¨â€¦â€¦

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªå¾ˆç›´è§‰çš„æƒ³æ³•æ˜¯ï¼Œæƒ³çœ‹çœ‹è¿™äº›å†…å­˜å¯¹è±¡çš„å¼•ç”¨å…³ç³»ã€‚

## Part.3--å†…å­˜å¼•ç”¨å…³ç³»ç«ç„°å›¾

å†…å­˜å¼•ç”¨å…³ç³»ç«ç„°å›¾ï¼Œæ˜¯ä¸€ç§å†…å­˜å¯¹è±¡å¼•ç”¨å…³ç³»çš„å¯è§†åŒ–æ–¹å¼ï¼Œæœ€æ—©åº”ç”¨äº OpenResty XRay äº§å“ã€‚è¿™ä¸ªå·¥å…·ç¡®å®æ˜¯å†…å­˜åˆ†æç¥å™¨ï¼Œç»™ä¸å°‘çš„å®¢æˆ·å®šä½è¿‡å†…å­˜é—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç§»æ­¥Â OpenResty å®˜æ–¹åšå®¢[2]ã€‚

ä¸‹å›¾æ˜¯ç”±ä¸€ä¸ª MOSN æœåŠ¡äº§ç”Ÿçš„ï¼Œè‡ªä¸‹è€Œä¸Šè¡¨ç¤ºçš„æ˜¯ä» GC root åˆ° GC object çš„å¼•ç”¨å…³ç³»é“¾ï¼Œå®½åº¦è¡¨ç¤ºçš„æ˜¯å¯¹è±¡å¤§å° *ï¼ˆä¹ŸåŒ…æ‹¬å…¶å¼•ç”¨çš„å¯¹è±¡çš„å¤§å°ä¹‹å’Œï¼‰* ã€‚

æœ‰äº†è¿™æ ·çš„å¯è§†åŒ–ç»“æœï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´è§‚çš„çœ‹åˆ°å†…å­˜å¯¹è±¡çš„å¼•ç”¨å…³ç³»ã€‚

æ¯”å¦‚ä¸‹å›¾æœ€å®½çš„éƒ¨åˆ†ï¼Œè¡¨ç¤ºçš„æ˜¯ MOSN ä¸­ cluster_manager å…¨å±€å˜é‡ä¸­å¼•ç”¨çš„ cluster å†…å­˜å¯¹è±¡ï¼š

*[https://github.com/mosn/mosn/blob/aecc93c4b2b4801e7992387f245fe9eefa45733d/pkg/upstream/cluster/cluster_manager.go#L82](https://github.com/mosn/mosn/blob/aecc93c4b2b4801e7992387f245fe9eefa45733d/pkg/upstream/cluster/cluster_manager.go#L82)*

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6aa635e17d6e48d1b55819ec52102c7b~tplv-k3u1fbpfcp-zoom-1.image)

## Part.4--å®ç°åŸç†

åœ¨ç”Ÿæˆç«ç„°å›¾ä¹‹å‰ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æå–ä¸¤ä¸ªå…³é”®ä¿¡æ¯ï¼š

**-** æ¯ä¸ªå†…å­˜å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼›

**-** æ¯ä¸ªå†…å­˜å¯¹è±¡çš„ç±»å‹ã€‚

### å¼•ç”¨å…³ç³»

è·å–å¼•ç”¨å…³ç³»æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ heap ä¸­æ‰¾åˆ°æ‰€æœ‰çš„ GC å¯¹è±¡ã€‚ç„¶åéå†æ‰€æœ‰çš„å¯¹è±¡ï¼Œå†ç»“åˆ bitmap ä¿¡æ¯ï¼Œè·å–è¿™ä¸ªå¯¹è±¡å¼•ç”¨çš„å…¶ä»–å¯¹è±¡ã€‚åŸºæœ¬åŸç†è·Ÿ GC mark æ˜¯ç±»ä¼¼çš„ï¼Œè™½ç„¶å®ç°ä¸Šå¾ˆä¸ä¸€æ ·ï¼Œä½†å› ä¸ºè¿™ä¸ªæ˜¯ç¦»çº¿å·¥å…·ï¼Œå¯ä»¥ç®€å•ç²—æš´çš„å®ç°ã€‚

### ç±»å‹æ¨å¯¼

Go è¯­è¨€ä½œä¸ºç¼–è¯‘å‹é™æ€è¯­è¨€ï¼Œæ˜¯ä¸éœ€è¦ä¸ºæ¯ä¸ªå†…å­˜å¯¹è±¡å­˜å‚¨ç±»å‹ä¿¡æ¯çš„ *ï¼ˆæœ‰ç‚¹ä¾‹å¤–çš„æ˜¯ interfaceï¼‰* ã€‚å¦‚æœæ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œæ¯”å¦‚ Luaï¼Œåˆ™ä¼šæ–¹ä¾¿å¾ˆå¤šï¼Œæ¯ä¸ª GC å¯¹è±¡éƒ½å­˜å‚¨äº†å¯¹è±¡çš„ç±»å‹ã€‚

æ‰€ä»¥ï¼Œè¦è·å–æ¯ä¸ªå¯¹è±¡çš„ç±»å‹ï¼Œè¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦çš„ï¼Œä¹Ÿæ˜¯æŠ•å…¥æ—¶é—´æœ€å¤šçš„ä¸€å—ã€‚å½“ç„¶ï¼Œè¿˜æ˜¯æœ‰è§£å†³åŠæ³•çš„ï¼Œç®€å•æ¥è¯´å°±æ˜¯åšé€†å‘ç±»å‹æ¨å¯¼ï¼Œæ ¹æ®å·²çŸ¥å†…å­˜çš„ç±»å‹ä¿¡æ¯ï¼Œæ¨å¯¼è¢«å¼•ç”¨çš„å†…å­˜å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€‚

è¿™å—è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹è¿™ç¯‡ã€ŠGo è¯­è¨€ï¼Œå¦‚ä½•åšé€†å‘ç±»å‹æ¨å¯¼ã€‹[3]çš„ä»‹ç»ã€‚

### ç”Ÿæˆè¿‡ç¨‹

æœ‰äº†è¿™ä¸¤ä¸ªå…³é”®ä¿¡æ¯ä¹‹åï¼Œç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼š

**1.** è·å–æ‰€æœ‰çš„å†…å­˜å¯¹è±¡ï¼ŒåŒ…æ‹¬ç±»å‹ã€å¤§å°ï¼Œä»¥åŠä»–ä»¬ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œå½¢æˆä¸€ä¸ªå›¾ï¼›

**2.** ä» root å¯¹è±¡å‡ºå‘ï¼ŒæŒ‰ç…§å±‚æ¬¡éå†ï¼Œå½¢æˆä¸€æ£µæ ‘ *ï¼ˆä¹Ÿå°±æ˜¯å‰ªæè¿‡ç¨‹ï¼Œæ¯ä¸ªå¯¹è±¡åªèƒ½è¢«å¼•ç”¨ä¸€æ¬¡ï¼‰* ï¼›

**3.** å°†è¿™æ£µæ ‘çš„å®Œæ•´å¼•ç”¨å…³ç³»ï¼Œå½“åš backtrace dump ä¸‹æ¥ï¼Œcount æ˜¯å½“å‰èŠ‚ç‚¹çš„æ€»å¤§å° *ï¼ˆåŒ…æ‹¬æ‰€æœ‰å­èŠ‚ç‚¹ï¼‰* ï¼Œä¹Ÿå°±æ˜¯ç«ç„°å›¾ä¸Šçš„å®½åº¦ï¼›

**4.** ä» bt æ–‡ä»¶ç”Ÿæˆ svgï¼Œè¿™ä¸€æ­¥æ˜¯ brendangregg çš„ FlameGraph æ ‡å‡†å·¥å…·é“¾ã€‚

## Part.5--ä½¿ç”¨æ–¹å¼

è¿™ä¸ªå·¥å…·æ˜¯åŸºäº Go å®˜æ–¹çš„ viewcore æ”¹è¿›æ¥çš„ã€‚ä¸è¿‡ï¼Œé‰´äº Go å®˜æ–¹ä¸é‚£ä¹ˆçƒ­å¿ƒç»´æŠ¤ viewcore äº†ï¼ŒMOSN ç¤¾åŒºå…ˆ fork äº†ä¸€ä»½ï¼Œæäº†ä¸ª mosn åˆ†æ”¯ï¼Œä½œä¸º MOSN ç¤¾åŒºç»´æŠ¤çš„ä¸»åˆ†æ”¯ã€‚

ä¹‹å‰ä¹Ÿç»™ Go å®˜æ–¹ debug æäº¤äº†å¥½å‡ ä¸ª bugfixï¼Œç­‰åé¢æœ‰ç©ºï¼Œæˆ‘ä»¬å†å»æäº¤è¿™ä¸ª featureã€‚

æ‰€ä»¥ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```text
# ç¼–è¯‘ mosn ç»´æŠ¤çš„ viewcore
git clone git@github.com:mosn/debug.git
cd debug/cmd/viewcore
go build .

# å‡è®¾å·²ç»æœ‰äº†ä¸€ä¸ª core æ–‡ä»¶ï¼ˆCORE-FILEï¼‰
# ä»¥åŠå¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºæ–‡ä»¶ï¼ˆBIN-FILEï¼‰
viewcore CORE-FILE --exe BIN-FILE objref ref.bt

# ä¸‹è½½ FlameGraph å·¥å…·
git clone git@github.com:brendangregg/FlameGraph.git
../FlameGraph/stackcollapse-stap.pl ref.bt | ../FlameGraph/flamegraph.pl> ref.svg

# æµè§ˆå™¨æ‰“å¼€ ref.svg å³å¯çœ‹åˆ°ç«ç„°å›¾
```

å¦‚æœä½¿ç”¨ç¢°åˆ°é—®é¢˜ï¼Œå¯ä»¥éšæ—¶è”ç³»æˆ‘ä»¬æˆ–æäº¤ issueï¼ˆ[https://github.com/mosn/mosn/issues](https://github.com/mosn/mosn/issues)ï¼‰ã€‚

å½“ç„¶ï¼Œå€˜è‹¥ä½ æˆåŠŸå®šä½äº†æŸä¸ªé—®é¢˜ï¼Œä¹Ÿæ¬¢è¿ä¸æˆ‘ä»¬å…±åŒåˆ†äº«ï¼ŒLet's have fun togetherï¼

MOSN ç”¨æˆ·é’‰é’‰ç¾¤ï¼š**33547952**

### ç›¸å…³é“¾æ¥

[1] ã€ŠGo è¯­è¨€ pprof heap profile å®ç°æœºåˆ¶ã€‹ï¼š*[https://uncledou.site/2022/go-pprof-heap/](https://uncledou.site/2022/go-pprof-heap/)*

[2] OpenResty å®˜æ–¹åšå®¢ï¼š*[https://blog.openresty.com.cn/cn/openresty-xray-case-yundun/](https://blog.openresty.com.cn/cn/openresty-xray-case-yundun/)*

[3] ã€ŠGo è¯­è¨€ï¼Œå¦‚ä½•åšé€†å‘ç±»å‹æ¨å¯¼ã€‹ï¼š*[https://uncledou.site/2022/go-type-derivation/](https://uncledou.site/2022/go-type-derivation/)*

### äº†è§£æ›´å¤šâ€¦

**MOSNÂ Star ä¸€ä¸‹âœ¨ï¼š** *[https://github.com/mosn/mosn](https://github.com/mosn/mosn)*

**æ’æ’­ä¸€æ¡å¥½æ¶ˆæ¯ï¼ğŸ¤©**

å¯¹ Go è¯­è¨€å¼€å‘æ„Ÿå…´è¶£çš„å°ä¼™ä¼´ä»¬,æ¬¢è¿å¤§å®¶å‚ä¸åˆ°è¿‘æœŸæ­£çƒ­çš„Â **GoCity**Â é¡¹ç›®ä½“éªŒ

[ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹æ¼”ç¤ºè§†é¢‘](https://b23.tv/91Jb1Be)ï¼Œå¿«é€Ÿå…¥é—¨å§ğŸ¥³

### æœ¬å‘¨æ¨èé˜…è¯»

[MOSN åå‘é€šé“è¯¦è§£](http://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&mid=2247513902&idx=1&sn=be00c5af2e9775a4039430bf187e16f4&chksm=faa358f4cdd4d1e23d7e9c93b4a94d6e6c377f51eb5e96b6dd5f74b840e48ebd3f518c4bf80a&scene=21)

[Go åŸç”Ÿæ’ä»¶ä½¿ç”¨é—®é¢˜å…¨è§£æ](http://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&mid=2247512138&idx=1&sn=851abb8d07d47f703e33978c9c125c59&chksm=faa35f90cdd4d6869c6cd4934c042484dbe1063c3fb85462d2f33e936b96240ae33d02d18c3a&scene=21)

[Go ä»£ç åŸå¸‚ä¸Šäº‘--KusionStack å®è·µ](http://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&mid=2247515572&idx=1&sn=8fffc0fb13ffc8346e3ab151978d947f&chksm=faa3526ecdd4db789035b4c297811524cdf3ec6b659e283b0f9858147c7e37c4fea8b14b2fc6&scene=21)

[MOSN æ–‡æ¡£ä½¿ç”¨æŒ‡å—](http://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&mid=2247507103&idx=1&sn=e8da41af0ceaa18ae13f31ca2905da8e&chksm=faa33345cdd4ba5397a43adfe8cabdc85321d3f9f14066c470885b41e2f704ec505a9f086cec&scene=21)

æ¬¢è¿æ‰«ç å…³æ³¨ï¼š

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c573c68b15c47cab2a0012215229961~tplv-k3u1fbpfcp-zoom-1.image)
